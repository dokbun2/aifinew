<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Direct Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            background: #333;
            color: #0f0;
            border: 1px solid #0f0;
            cursor: pointer;
        }
        button:hover {
            background: #444;
        }
        .result {
            margin: 20px 0;
            padding: 15px;
            background: #000;
            border: 1px solid #0f0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ðŸ”§ Supabase Direct Connection Test</h1>

    <button onclick="testDirectConnection()">Test Direct Connection</button>
    <button onclick="testInsertUser()">Test Insert User</button>
    <button onclick="checkRLSStatus()">Check RLS Status</button>

    <div id="result" class="result"></div>

    <script type="module">
        import { SUPABASE_CONFIG } from './js/modules/supabase-config.js';

        const supabase = window.supabase.createClient(
            SUPABASE_CONFIG.url,
            SUPABASE_CONFIG.anonKey
        );

        window.testDirectConnection = async function() {
            const result = document.getElementById('result');
            result.textContent = 'Testing connection...\n';

            try {
                // Test basic connection
                const { data, error } = await supabase
                    .from('users')
                    .select('count')
                    .limit(1);

                if (error) {
                    result.textContent += `âŒ Connection Error:\n${JSON.stringify(error, null, 2)}`;
                } else {
                    result.textContent += `âœ… Connection Success!\n`;
                }
            } catch (e) {
                result.textContent += `âŒ Exception: ${e.message}`;
            }
        }

        window.testInsertUser = async function() {
            const result = document.getElementById('result');
            result.textContent = 'Testing insert...\n';

            const testUser = {
                email: `test_${Date.now()}@gmail.com`,
                name: 'Direct Test User',
                picture: '',
                google_id: `test_${Date.now()}`,
                status: 'pending',
                created_at: new Date().toISOString(),
                last_login: new Date().toISOString(),
                login_count: 1,
                metadata: {
                    test: true,
                    timestamp: new Date().toISOString()
                }
            };

            try {
                const { data, error } = await supabase
                    .from('users')
                    .insert(testUser)
                    .select();

                if (error) {
                    result.textContent += `âŒ Insert Error:\n${JSON.stringify(error, null, 2)}\n\n`;

                    if (error.code === '42501') {
                        result.textContent += 'âš ï¸ This is a RLS (Row Level Security) error!\n';
                        result.textContent += 'Solution: Run this SQL in Supabase:\n\n';
                        result.textContent += 'ALTER TABLE users DISABLE ROW LEVEL SECURITY;\n';
                    }
                } else {
                    result.textContent += `âœ… Insert Success!\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (e) {
                result.textContent += `âŒ Exception: ${e.message}`;
            }
        }

        window.checkRLSStatus = async function() {
            const result = document.getElementById('result');
            result.textContent = 'Checking RLS status...\n\n';

            // Test SELECT
            const { data: selectData, error: selectError } = await supabase
                .from('users')
                .select('*')
                .limit(1);

            result.textContent += selectError
                ? `SELECT: âŒ ${selectError.message}\n`
                : `SELECT: âœ… OK (${selectData?.length || 0} rows)\n`;

            // Test INSERT
            const testEmail = `rls_test_${Date.now()}@test.com`;
            const { error: insertError } = await supabase
                .from('users')
                .insert({
                    email: testEmail,
                    name: 'RLS Test',
                    status: 'pending'
                });

            result.textContent += insertError
                ? `INSERT: âŒ ${insertError.message}\n`
                : `INSERT: âœ… OK\n`;

            // Test UPDATE
            const { error: updateError } = await supabase
                .from('users')
                .update({ last_login: new Date().toISOString() })
                .eq('email', testEmail);

            result.textContent += updateError
                ? `UPDATE: âŒ ${updateError.message}\n`
                : `UPDATE: âœ… OK\n`;

            // Test DELETE
            const { error: deleteError } = await supabase
                .from('users')
                .delete()
                .eq('email', testEmail);

            result.textContent += deleteError
                ? `DELETE: âŒ ${deleteError.message}\n`
                : `DELETE: âœ… OK\n`;

            // Summary
            result.textContent += '\n--- Summary ---\n';
            if (insertError?.code === '42501') {
                result.textContent += 'âš ï¸ RLS is blocking INSERT operations!\n';
                result.textContent += 'Run this in Supabase SQL Editor:\n\n';
                result.textContent += 'ALTER TABLE users DISABLE ROW LEVEL SECURITY;';
            } else if (!selectError && !insertError && !updateError) {
                result.textContent += 'âœ… All operations working! RLS is properly configured.';
            }
        }

        // Auto-run connection test on load
        window.addEventListener('load', () => {
            window.testDirectConnection();
        });
    </script>
</body>
</html>