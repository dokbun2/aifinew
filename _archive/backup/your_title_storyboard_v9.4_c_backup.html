<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì»¨ì…‰ì•„íŠ¸ í”„ë¡¬í”„íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬</title>
    
    <!-- CSS íŒŒì¼ ë§í¬ -->
    <link rel="stylesheet" href="concept-art-styles.css">
    
    <!-- SEO -->
    <meta name="description" content="ìºë¦­í„°, ì¥ì†Œ, ì†Œí’ˆì˜ ì»¨ì…‰ì•„íŠ¸ ìƒì„±ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ ë° ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ ì‹œìŠ¤í…œ">
    <meta name="keywords" content="ì»¨ì…‰ì•„íŠ¸, AI ì´ë¯¸ì§€ìƒì„±, í”„ë¡¬í”„íŠ¸, ìºë¦­í„° ë””ìì¸, ë°°ê²½, ì†Œí’ˆ, Midjourney, DALL-E">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://aifiwb.netlify.app/your_title_storyboard_v9.4_c.html">
    <meta property="og:title" content="ì»¨ì…‰ì•„íŠ¸ í”„ë¡¬í”„íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬">
    <meta property="og:description" content="ìºë¦­í„°, ì¥ì†Œ, ì†Œí’ˆì˜ ì»¨ì…‰ì•„íŠ¸ ìƒì„±ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ ë° ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ ì‹œìŠ¤í…œ. ë‹¤ì¤‘ AI ë„êµ¬ í”„ë¡¬í”„íŠ¸ ì§€ì›">
    <meta property="og:image" content="https://aifiwb.netlify.app/og-image-concept.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:locale" content="ko_KR">
    <meta property="og:site_name" content="AIFI í”„ë¡œì íŠ¸">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://aifiwb.netlify.app/your_title_storyboard_v9.4_c.html">
    <meta property="twitter:title" content="ì»¨ì…‰ì•„íŠ¸ í”„ë¡¬í”„íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬">
    <meta property="twitter:description" content="ìºë¦­í„°, ì¥ì†Œ, ì†Œí’ˆì˜ ì»¨ì…‰ì•„íŠ¸ ìƒì„±ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ ë° ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ ì‹œìŠ¤í…œ">
    <meta property="twitter:image" content="https://aifiwb.netlify.app/og-image-concept.jpg">

    <!-- ì¹´ì¹´ì˜¤í†¡ -->
    <meta property="kakao:title" content="ì»¨ì…‰ì•„íŠ¸ í”„ë¡¬í”„íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬">
    <meta property="kakao:description" content="ìºë¦­í„°, ì¥ì†Œ, ì†Œí’ˆì˜ ì»¨ì…‰ì•„íŠ¸ ìƒì„±ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ ë° ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ ì‹œìŠ¤í…œ">
    <meta property="kakao:image" content="https://aifiwb.netlify.app/og-image-concept.jpg">

    <!-- íŒŒë¹„ì½˜ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¨</text></svg>">
</head>
<body>
    <div class="header">
        <div class="header-left">
            <a href="index.html" class="home-btn">ğŸ  í™ˆ</a>
            <h1 class="header-title">ì»¨ì…‰ì•„íŠ¸ í”„ë¡¬í”„íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬</h1>
        </div>
    </div>
    <div class="container">
        <header>
            <h1>ğŸ¨ ì»¨ì…‰ì•„íŠ¸ í”„ë¡¬í”„íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬</h1>
            <p>ìŠ¤í…Œì´ì§€ 4: ì»¨ì…‰ì•„íŠ¸ í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§ ê²°ê³¼ë¬¼ (ìŠ¤í‚¤ë§ˆ v1.2 í˜¸í™˜)</p>
            <div id="project-info-display" class="project-info-bar">
                <span>í”„ë¡œì íŠ¸ ID: ë°ì´í„° ì—†ìŒ</span>
                <span>ì´ ì»¨ì…‰ì•„íŠ¸: ë°ì´í„° ì—†ìŒ</span>
                <span>ë°ì´í„° ë²„ì „: ë°ì´í„° ì—†ìŒ</span>
                <span>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ë°ì´í„° ì—†ìŒ</span>
            </div>
            <div class="user-guide">
                <p><strong>ì‚¬ìš© ì•ˆë‚´:</strong> ìƒì„±ëœ ì´ë¯¸ì§€ URLì„ ì¶”ê°€í•˜ê³ , ì‘ì—…ì´ ì™„ë£Œë˜ë©´ "JSONìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ëª¨ë“  ë°ì´í„°ë¥¼ ì €ì¥í•˜ì„¸ìš”. ì €ì¥ëœ JSON íŒŒì¼ì„ ì´ HTML íŒŒì¼ê³¼ ê°™ì€ í´ë”ì— 'concept_art_data.json' (ë˜ëŠ” ì‚¬ìš©ìê°€ ì§€ì •í•œ íŒŒì¼ëª…)ìœ¼ë¡œ ì €ì¥í•œ í›„, "JSON ê°€ì ¸ì˜¤ê¸°"ë¥¼ í†µí•´ ë‹¤ì‹œ ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            <div class="button-group">
                <button id="export-json-btn" class="btn btn-primary">JSONìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°</button>
                <input type="file" id="import-json-input" accept=".json" style="display: none;">
                <button id="import-json-btn" class="btn btn-secondary">JSON ê°€ì ¸ì˜¤ê¸°</button>
                <button id="reset-data-btn" class="btn btn-danger">ë°ì´í„° ì´ˆê¸°í™”</button>
            </div>
        </header>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="category">
                    <div class="category-title">ìºë¦­í„°</div>
                    <ul class="concept-list" id="character-list"></ul>
                </div>
                <div class="category">
                    <div class="category-title">ì¥ì†Œ</div>
                    <ul class="concept-list" id="location-list"></ul>
                </div>
                <div class="category">
                    <div class="category-title">ì†Œí’ˆ</div>
                    <ul class="concept-list" id="prop-list"></ul>
                </div>
            </div>
            
            <div class="content-area">
                <div id="concept-detail">
                    <h2 id="concept-title">ì»¨ì…‰ì•„íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
                    
                    <div class="tabs">
                        <button class="tab-button active" onclick="openTab(event, 'csv-tab')">CSV ë°ì´í„°</button>
                        <button class="tab-button" onclick="openTab(event, 'prompts-tab')">ê¸°ë³¸ í”„ë¡¬í”„íŠ¸</button>
                        <button class="tab-button" onclick="openTab(event, 'variants-tab')">ìºë¦­í„° ë³€í˜•</button>
                        <button class="tab-button" onclick="openTab(event, 'image-gallery-tab')">ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬</button>
                    </div>
                    
                    <div id="csv-tab" class="tab-content active">
                        <h3>CSV ë°ì´í„°</h3>
                        <table class="csv-table" id="csv-data-table">
                            <thead><tr><th>ID</th><th>ê°’</th></tr></thead>
                            <tbody><tr><td colspan="2">ì»¨ì…‰ì•„íŠ¸ë¥¼ ì„ íƒí•˜ë©´ CSV ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</td></tr></tbody>
                        </table>
                        <button class="btn btn-primary" onclick="copyCSV()">CSV ë³µì‚¬</button>
                    </div>
                    
                    <div id="prompts-tab" class="tab-content">
                        <h3>ê¸°ë³¸ í”„ë¡¬í”„íŠ¸</h3>
                        <div class="tabs ai-tabs" id="base-prompt-ai-tabs">
                            {/* AI íƒ­ ë²„íŠ¼ì€ JavaScriptë¡œ ë™ì  ìƒì„± */}
                        </div>
                        <div id="base-prompt-ai-content-area">
                            {/* AI íƒ­ ì½˜í…ì¸ ëŠ” JavaScriptë¡œ ë™ì  ìƒì„± */}
                        </div>
                    </div>
                    
                    <div id="variants-tab" class="tab-content">
                        <h3>ìºë¦­í„° ë³€í˜• í”„ë¡¬í”„íŠ¸</h3>
                         <div id="variants-placeholder" class="no-image-message" style="display: none;">ìºë¦­í„° íƒ€ì…ì˜ ì»¨ì…‰ì•„íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. ì¥ì†Œ ë° ì†Œí’ˆì€ ë³€í˜• í”„ë¡¬í”„íŠ¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
                        <div id="variants-main-content">
                            <div class="tabs ai-tabs" id="variant-prompt-ai-tabs">
                                {/* ë³€í˜• AI íƒ­ ë²„íŠ¼ì€ JavaScriptë¡œ ë™ì  ìƒì„± */}
                            </div>
                            <div id="variant-prompt-ai-content-area">
                                {/* ë³€í˜• AI íƒ­ ì½˜í…ì¸ ëŠ” JavaScriptë¡œ ë™ì  ìƒì„± */}
                            </div>
                        </div>
                    </div>
                    
                    <div id="image-gallery-tab" class="tab-content">
                        <h3>ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬</h3>
                        <div class="image-gallery" id="image-gallery-content">
                            <div class="no-image-message">ì»¨ì…‰ì•„íŠ¸ë¥¼ ì„ íƒí•˜ê³  ì´ë¯¸ì§€ë¥¼ ì¶”ê°€í•˜ë©´ ê°¤ëŸ¬ë¦¬ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="toast-message" class="toast"></div>
	<!-- ì´ë¯¸ì§€ ëª¨ë‹¬ -->
	<div id="imageModal" class="image-modal" onclick="closeImageModal(event)">
		<span class="image-modal-close" onclick="closeImageModal(event)">&times;</span>
		<img class="image-modal-content" id="modalImage">
	</div>

    <!-- JavaScript ëª¨ë“ˆ -->
    <script type="module" src="concept-art-app.js"></script>
</body>
</html>
        let currentVariantsAITab = null;
        let currentVariantTypeTab = { midjourney: 'face_views_4', leonardo: 'face_views_4', ideogram: 'face_views_4', imagefx: 'face_views_4' };

        const AI_TOOLS = ['midjourney', 'leonardo', 'ideogram', 'imagefx', 'openart'];
        const VARIATION_TYPES_MAP = { // HTML íƒ­ ID -> ìŠ¤í‚¤ë§ˆ í•„ë“œëª… (MidjourneyëŠ” permutation ì ‘ë¯¸ì‚¬ ê³ ë ¤)
            'face_views_4': { name_kr: "ì–¼êµ´ 4ë©´", schema_key_base: 'face_views_4' },
            'expressions_5': { name_kr: "ì£¼ìš” í‘œì • 5ì¢…", schema_key_base: 'expressions_5' },
            'body_views_4': { name_kr: "ì „ì‹  4ë©´", schema_key_base: 'body_views_4' }
        };


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('export-json-btn').addEventListener('click', exportToJSON);
            document.getElementById('import-json-btn').addEventListener('click', () => document.getElementById('import-json-input').click());
            document.getElementById('import-json-input').addEventListener('change', importFromJSON);
			
            document.getElementById('reset-data-btn').addEventListener('click', function() {
                if (confirm('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    localStorage.removeItem('conceptArtManagerData_v1.2');
                    showToast('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    setTimeout(() => location.reload(), 1000);
                }
            });
            
            buildAITabs();
            
            // URL íŒŒë¼ë¯¸í„° ì²´í¬ ë° ìë™ JSON ì²˜ë¦¬
            const urlParams = new URLSearchParams(window.location.search);
            
            // Stage 4ì—ì„œ ì„ì‹œ ì €ì¥ëœ JSON íŒŒì¼ ìë™ ë¡œë“œ
            if (urlParams.get('loadStage4Json') === 'true') {
                console.log('ğŸ”„ Stage 4 ì„ì‹œ ì €ì¥ëœ JSON íŒŒì¼ ìë™ ë¡œë“œ ì‹¤í–‰...');
                setTimeout(() => {
                    const tempJson = localStorage.getItem('stage4TempJson');
                    const tempFileName = localStorage.getItem('stage4TempFileName');
                    
                    if (tempJson && tempFileName) {
                        try {
                            console.log(`ğŸ“ Stage 4 ì„ì‹œ JSON íŒŒì¼ ë¡œë“œ: ${tempFileName}`);
                            
                            const data = JSON.parse(tempJson);
                            processLoadedJSON(data);
                            showToast(`${tempFileName} íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`);
                            
                            // ì„ì‹œ ë°ì´í„° ì •ë¦¬
                            localStorage.removeItem('stage4TempJson');
                            localStorage.removeItem('stage4TempFileName');
                            
                        } catch (error) {
                            console.error('Stage 4 ì„ì‹œ JSON ë¡œë“œ ì˜¤ë¥˜:', error);
                            showToast('ì„ì‹œ ì €ì¥ëœ JSON íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            localStorage.removeItem('stage4TempJson');
                            localStorage.removeItem('stage4TempFileName');
                        }
                    } else {
                        console.log('ì„ì‹œ ì €ì¥ëœ Stage 4 JSON ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        showToast('ì„ì‹œ ì €ì¥ëœ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                }, 1000);
            } else {
                // localStorageì—ì„œ Stage 4 ë°ì´í„° í™•ì¸
                const tempJson = localStorage.getItem('stage4TempJson');
                const tempFileName = localStorage.getItem('stage4TempFileName');
                
                if (tempJson && tempFileName) {
                    console.log('ğŸ”„ localStorageì—ì„œ Stage 4 ë°ì´í„° ë°œê²¬, ìë™ ë¡œë“œ ì‹¤í–‰...');
                    setTimeout(() => {
                        try {
                            console.log(`ğŸ“ Stage 4 ì„ì‹œ JSON íŒŒì¼ ë¡œë“œ: ${tempFileName}`);
                            
                            const data = JSON.parse(tempJson);
                            processLoadedJSON(data);
                            showToast(`${tempFileName} íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`);
                            
                            // ì„ì‹œ ë°ì´í„° ì •ë¦¬
                            localStorage.removeItem('stage4TempJson');
                            localStorage.removeItem('stage4TempFileName');
                            
                        } catch (error) {
                            console.error('Stage 4 ì„ì‹œ JSON ë¡œë“œ ì˜¤ë¥˜:', error);
                            showToast('ì„ì‹œ ì €ì¥ëœ JSON íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            localStorage.removeItem('stage4TempJson');
                            localStorage.removeItem('stage4TempFileName');
                        }
                    }, 1000);
                } else {
                    loadLocalJsonFile(); // Attempt to load default JSON first
                }
            }
        });

        // --- Toast Message Utility ---
        function showToast(message) {
            const toast = document.getElementById('toast-message');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // --- Data Loading and Saving ---
        function loadLocalJsonFile() {
            fetch('./' + window.location.pathname.split('/').pop().replace('.html', '.json')) // Default file to load
                .then(response => {
                    if (!response.ok) throw new Error('Default JSON file not found. Trying local storage.');
                    return response.json();
                })
                .then(data => processLoadedJSON(data))
                .catch(error => {
                    console.warn(error.message);
                    loadDataFromLocalStorage();
                });
        }

        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    processLoadedJSON(data);
                } catch (error) {
                    console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', error);
                    showToast('ìœ íš¨í•˜ì§€ ì•Šì€ JSON íŒŒì¼ì…ë‹ˆë‹¤.');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; 
        }
        
        function processLoadedJSON(data) {
            if (data && data.concept_art_collection && data.project_info) { // Valid Stage 4 Schema v1.2
                projectInfo = data.project_info;
                dataVersion = data.version || "N/A";
                dataTimestamp = data.timestamp || "N/A";
                
				// ë¶€ë¶„ ì—…ë°ì´íŠ¸: ê¸°ì¡´ ë°ì´í„°ì— ìƒˆ ë°ì´í„° ë³‘í•©
				Object.keys(data.concept_art_collection).forEach(type => {
					if (!conceptArtData[type]) conceptArtData[type] = {};
					Object.assign(conceptArtData[type], data.concept_art_collection[type]);
				});
                
                updateProjectInfoDisplay();
                updateAllUILists();
                selectFirstConcept(); 
                saveDataToLocalStorage(); // Save valid imported data to local storage
                showToast('JSON ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.');
                console.log('ì„±ê³µ: Stage 4 Schema v1.2 í˜•ì‹ìœ¼ë¡œ JSON ë¡œë“œ/ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ.');
            } else {
                showToast('ìœ íš¨í•œ Stage 4 JSON ë°ì´í„° í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
                console.error('ë¡œë“œëœ JSONì´ Stage 4 Schema v1.2 í˜•ì‹ì´ ì•„ë‹˜:', data);
                 // í˜•ì‹ì´ ì•ˆë§ìœ¼ë©´, ê¸°ì¡´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë°ì´í„°ë¼ë„ ë¶ˆëŸ¬ì˜¤ë„ë¡ ì‹œë„
                loadDataFromLocalStorage(false); // silent = false, to avoid re-selecting first concept if already done
            }
        }

        function exportToJSON() {
            const fullExportData = {
                stage: 4,
                version: dataVersion === "N/A" ? "1.2" : dataVersion, // Use loaded version or default
                timestamp: new Date().toISOString(),
                project_info: projectInfo,
                concept_art_collection: conceptArtData
            };
            const jsonString = JSON.stringify(fullExportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = window.location.pathname.split('/').pop().replace('.html', '.json');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('JSON íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function saveDataToLocalStorage() {
            try {
                const dataToStore = { projectInfo, dataVersion, dataTimestamp, conceptArtData };
                localStorage.setItem('conceptArtManagerData_v1.2', JSON.stringify(dataToStore));
                console.log("ë°ì´í„°ê°€ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (e) {
                console.error("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì‹¤íŒ¨:", e);
                showToast("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì‹¤íŒ¨. ë¸Œë¼ìš°ì € ìš©ëŸ‰ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            }
        }

        function loadDataFromLocalStorage(selectFirst = true) {
            const storedDataString = localStorage.getItem('conceptArtManagerData_v1.2');
            if (storedDataString) {
                try {
                    const storedData = JSON.parse(storedDataString);
                    projectInfo = storedData.projectInfo || { project_id: "N/A", total_concept_arts: 0 };
                    dataVersion = storedData.dataVersion || "N/A";
                    dataTimestamp = storedData.dataTimestamp || "N/A";
                    conceptArtData = storedData.conceptArtData || { characters: {}, locations: {}, props: {} };
                    
                    updateProjectInfoDisplay();
                    updateAllUILists();
                    if(selectFirst) selectFirstConcept();
                    console.log("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ.");
                } catch (error) {
                    console.error('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', error);
                }
            } else {
                console.log("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ëœ ë°ì´í„° ì—†ìŒ.");
                 if(selectFirst) updateNoDataState(); // ìµœì´ˆ ë¡œë“œ ì‹œ ë°ì´í„° ì—†ìœ¼ë©´ ì´ˆê¸°í™”ë©´
            }
        }
        
        function updateNoDataState() {
            updateProjectInfoDisplay(); // ê¸°ë³¸ê°’ìœ¼ë¡œ í‘œì‹œ
            ['character-list', 'location-list', 'prop-list'].forEach(listId => populateConceptList(listId, {}, ''));
            document.getElementById('concept-title').textContent = 'ì»¨ì…‰ì•„íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”';
            document.getElementById('csv-data-table').querySelector('tbody').innerHTML = '<tr><td colspan="2">ì»¨ì…‰ì•„íŠ¸ë¥¼ ì„ íƒí•˜ë©´ CSV ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</td></tr>';
            clearPromptDisplay('base-prompt-ai-content-area');
            clearPromptDisplay('variant-prompt-ai-content-area');
            document.getElementById('image-gallery-content').innerHTML = '<div class="no-image-message">ì»¨ì…‰ì•„íŠ¸ë¥¼ ì„ íƒí•˜ê³  ì´ë¯¸ì§€ë¥¼ ì¶”ê°€í•˜ë©´ ê°¤ëŸ¬ë¦¬ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>';
        }

        // --- UI Update Functions ---
        function updateProjectInfoDisplay() {
            document.getElementById('project-info-display').innerHTML = `
                <span>í”„ë¡œì íŠ¸ ID: ${projectInfo.project_id}</span>
                <span>ì´ ì»¨ì…‰ì•„íŠ¸: ${projectInfo.total_concept_arts}</span>
                <span>ë°ì´í„° ë²„ì „: ${dataVersion}</span>
                <span>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${dataTimestamp ? new Date(dataTimestamp).toLocaleString() : 'N/A'}</span>
            `;
        }

        function updateAllUILists() {
            populateConceptList('character-list', conceptArtData.characters, 'characters');
            populateConceptList('location-list', conceptArtData.locations, 'locations');
            populateConceptList('prop-list', conceptArtData.props, 'props');
        }

        function populateConceptList(listId, dataObject, type) {
            const listElement = document.getElementById(listId);
            listElement.innerHTML = '';
            if (!dataObject || Object.keys(dataObject).length === 0) {
                listElement.innerHTML = '<li class="concept-item disabled" style="cursor:default; color:#6c757d;">í•­ëª© ì—†ìŒ</li>';
                return;
            }
            Object.keys(dataObject).forEach(id => { // id is target_name here
                const item = dataObject[id];
                const li = document.createElement('li');
                li.className = 'concept-item';
                li.textContent = item.name; 
                li.dataset.id = item.name; // Use name as id for selection
                li.dataset.type = type;
                li.onclick = () => {
                    document.querySelectorAll('.concept-item.active').forEach(activeItem => activeItem.classList.remove('active'));
                    li.classList.add('active');
                    showConceptDetails(item.name, type);
                };
                listElement.appendChild(li);
            });
        }
        
        function selectFirstConcept() {
            const categories = ['characters', 'locations', 'props'];
            for (const type of categories) {
                if (conceptArtData[type] && Object.keys(conceptArtData[type]).length > 0) {
                    const firstId = Object.keys(conceptArtData[type])[0]; // This is target_name
                    const firstConceptElement = document.querySelector(`.concept-item[data-id="${firstId}"][data-type="${type}"]`);
                    if (firstConceptElement) {
                         firstConceptElement.click(); // Trigger click to select and show details
                         return;
                    }
                }
            }
            // If no concepts exist at all
            updateNoDataState();
        }

        function showConceptDetails(id, type) { // id is target_name
            currentConceptId = id;
            currentConceptType = type;
            const concept = conceptArtData[type]?.[id];

            if (!concept) {
                console.error(`Concept ${id} of type ${type} not found.`);
                updateNoDataState(); // Or some error state
                return;
            }

            document.getElementById('concept-title').textContent = concept.name;
            updateCSVTable(concept.csv_data || {});
            displayBasePrompts(concept.prompts || {});
            displayVariantPrompts(concept.variations || {}, concept.type);
            updateImageGallery(concept);

            // Activate the first main tab (CSV)
            openTab(null, 'csv-tab');
        }

        function updateCSVTable(csvData) {
            const tbody = document.getElementById('csv-data-table').querySelector('tbody');
            tbody.innerHTML = '';
            if (!csvData || Object.keys(csvData).length === 0) {
                tbody.innerHTML = '<tr><td colspan="2">CSV ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            const sortedIds = Object.keys(csvData).sort((a, b) => parseInt(a) - parseInt(b));
            sortedIds.forEach(id => {
                const tr = tbody.insertRow();
                tr.insertCell().textContent = id;
                tr.insertCell().textContent = csvData[id];
            });
        }
        
        function copyCSV() {
            if (!currentConceptId || !currentConceptType) {
                showToast('ì„ íƒëœ ì»¨ì…‰ì•„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const concept = conceptArtData[currentConceptType][currentConceptId];
            const csvData = concept.csv_data || {};
            if (Object.keys(csvData).length === 0) {
                showToast('ë³µì‚¬í•  CSV ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            let csvText = Object.keys(csvData)
                              .sort((a,b) => parseInt(a) - parseInt(b))
                              .map(id => `${id},"${(csvData[id] || '').replace(/"/g, '""')}"`)
                              .join('\n');
            copyToClipboard(csvText, "CSV ë°ì´í„°ê°€");
        }

        function buildAITabs() {
            const basePromptAITabsContainer = document.getElementById('base-prompt-ai-tabs');
            const basePromptAIContentArea = document.getElementById('base-prompt-ai-content-area');
            const variantPromptAITabsContainer = document.getElementById('variant-prompt-ai-tabs');
            const variantPromptAIContentArea = document.getElementById('variant-prompt-ai-content-area');

            basePromptAITabsContainer.innerHTML = '';
            basePromptAIContentArea.innerHTML = '';
            variantPromptAITabsContainer.innerHTML = '';
            variantPromptAIContentArea.innerHTML = '';

            AI_TOOLS.forEach((tool, index) => {
                const toolNamePretty = tool.charAt(0).toUpperCase() + tool.slice(1);

                // Base Prompts Tabs
                let button = document.createElement('button');
                button.className = 'tab-button' + (index === 0 ? ' active' : '');
                button.textContent = toolNamePretty;
                button.onclick = (event) => openAITab(event, tool, 'base-prompt-ai-tabs', 'base-prompt-ai-content-area');
                basePromptAITabsContainer.appendChild(button);

                let contentDiv = document.createElement('div');
                contentDiv.id = `base-prompt-${tool}-content`;
                contentDiv.className = 'ai-tab-content' + (index === 0 ? ' active' : '');
                contentDiv.innerHTML = `
                    <div class="prompt-container">
                        <h4>ì˜ì–´ ì›ë³¸ í”„ë¡¬í”„íŠ¸</h4>
                        <div class="prompt-box" id="${tool}-prompt-english">í”„ë¡¬í”„íŠ¸ ì •ë³´ ì—†ìŒ</div>
                        <div class="prompt-actions"><button class="btn btn-secondary" onclick="copyIndividualPrompt('${tool}', 'prompt_english')">ì˜ì–´ ì›ë³¸ ë³µì‚¬</button></div>
                    </div>
                    <div class="prompt-container">
                        <h4>ë²ˆì—­ë³¸ í”„ë¡¬í”„íŠ¸</h4>
                        <div class="prompt-box" id="${tool}-prompt-translated">ë²ˆì—­ë³¸ ì •ë³´ ì—†ìŒ</div>
                        <div class="prompt-actions"><button class="btn btn-secondary" onclick="copyIndividualPrompt('${tool}', 'prompt_translated')">ë²ˆì—­ë³¸ ë³µì‚¬</button></div>
                    </div>
                    ${ (tool === 'midjourney' || tool === 'leonardo' || tool === 'imagefx' || tool === 'openart') ? `
                    <div class="prompt-container">
                        <h4>${tool === 'midjourney' ? 'íŒŒë¼ë¯¸í„°' : 'ë„¤ê±°í‹°ë¸Œ í”„ë¡¬í”„íŠ¸'}</h4>
                        <div class="prompt-box" id="${tool}-${tool === 'midjourney' ? 'parameters' : 'negative-prompt'}">ì •ë³´ ì—†ìŒ</div>
                        <div class="prompt-actions"><button class="btn btn-secondary" onclick="copyIndividualPrompt('${tool}', '${tool === 'midjourney' ? 'parameters' : 'negative_prompt'}')">ë³µì‚¬</button></div>
                    </div>` : ''}
                    <div class="image-preview-container">
                        <h4>ìƒì„±ëœ ì´ë¯¸ì§€</h4>
                        <div class="image-display-area" id="${tool}-base-image-display">
                            <div class="no-image-message">ì´ë¯¸ì§€ ì—†ìŒ</div>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button class="btn btn-secondary" onclick="addImageUrl('${tool}', 'base')">ğŸ”— URL ì…ë ¥</button>
                            <button class="btn btn-secondary" onclick="uploadImageFile('${tool}', 'base')">ğŸ“ íŒŒì¼ ì—…ë¡œë“œ</button>
                        </div>
                    </div>`;
                basePromptAIContentArea.appendChild(contentDiv);
                
                // Variant Prompts Tabs
                button = document.createElement('button');
                button.className = 'tab-button' + (index === 0 ? ' active' : '');
                button.textContent = toolNamePretty;
                button.onclick = (event) => openAITab(event, tool, 'variant-prompt-ai-tabs', 'variant-prompt-ai-content-area');
                variantPromptAITabsContainer.appendChild(button);

                contentDiv = document.createElement('div');
                contentDiv.id = `variant-prompt-${tool}-content`;
                contentDiv.className = 'variant-ai-content' + (index === 0 ? ' active' : '');
                
                let nestedTabsHTML = '<div class="nested-tabs">';
                Object.keys(VARIATION_TYPES_MAP).forEach((typeKey, typeIdx) => {
                    nestedTabsHTML += `<button class="nested-tab-button ${typeIdx === 0 ? 'active' : ''}" onclick="openNestedTab(event, '${tool}', '${typeKey}')">${VARIATION_TYPES_MAP[typeKey].name_kr}</button>`;
                });
                nestedTabsHTML += '</div>';
                contentDiv.innerHTML = nestedTabsHTML;

                Object.keys(VARIATION_TYPES_MAP).forEach((typeKey, typeIdx) => {
                    const nestedContentDiv = document.createElement('div');
                    nestedContentDiv.id = `${tool}-${typeKey}-variant-details`;
                    nestedContentDiv.className = 'nested-tab-content' + (typeIdx === 0 ? ' active' : '');
                    contentDiv.appendChild(nestedContentDiv);
                });
                variantPromptAIContentArea.appendChild(contentDiv);
            });
             if (AI_TOOLS.length > 0) {
                currentPromptsAITab = AI_TOOLS[0];
                currentVariantsAITab = AI_TOOLS[0];
            }
        }

        function displayBasePrompts(promptsByAI) {
            AI_TOOLS.forEach(tool => {
                const toolData = promptsByAI?.[tool];
                document.getElementById(`${tool}-prompt-english`).textContent = toolData?.prompt_english || 'ì˜ì–´ ì›ë³¸ ì •ë³´ ì—†ìŒ';
                document.getElementById(`${tool}-prompt-translated`).textContent = toolData?.prompt_translated || 'ë²ˆì—­ë³¸ ì •ë³´ ì—†ìŒ';
                
                const specialParamBox = document.getElementById(`${tool}-${tool === 'midjourney' ? 'parameters' : 'negative-prompt'}`);
                if (specialParamBox) {
                    if (tool === 'midjourney') {
                        specialParamBox.textContent = toolData?.parameters || 'íŒŒë¼ë¯¸í„° ì •ë³´ ì—†ìŒ';
                    } else if (tool === 'leonardo' || tool === 'imagefx' || tool === 'openart') {
                        specialParamBox.textContent = toolData?.negative_prompt || 'ë„¤ê±°í‹°ë¸Œ í”„ë¡¬í”„íŠ¸ ì •ë³´ ì—†ìŒ';
                    }
                }
                displayImage(tool, 'base', conceptArtData[currentConceptType]?.[currentConceptId]?.generated_images?.base_prompts?.[tool]);
            });
            if (AI_TOOLS.length > 0) openAITab(null, currentPromptsAITab || AI_TOOLS[0], 'base-prompt-ai-tabs', 'base-prompt-ai-content-area');
        }
        
        function clearPromptDisplay(areaId) {
            const contentArea = document.getElementById(areaId);
            if (!contentArea) return;
            AI_TOOLS.forEach(tool => {
                const englishBox = contentArea.querySelector(`#${tool}-prompt-english`);
                if(englishBox) englishBox.textContent = 'í”„ë¡¬í”„íŠ¸ ì •ë³´ ì—†ìŒ';
                const translatedBox = contentArea.querySelector(`#${tool}-prompt-translated`);
                if(translatedBox) translatedBox.textContent = 'ë²ˆì—­ë³¸ ì •ë³´ ì—†ìŒ';

                const specialParamBoxId = tool === 'midjourney' ? `${tool}-parameters` : `${tool}-negative-prompt`;
                const specialParamBox = contentArea.querySelector(`#${specialParamBoxId}`);
                if(specialParamBox) specialParamBox.textContent = 'ì •ë³´ ì—†ìŒ';
                
                const imageDisplay = contentArea.querySelector(`#${tool}-base-image-display`);
                if(imageDisplay) imageDisplay.innerHTML = '<div class="no-image-message">ì´ë¯¸ì§€ ì—†ìŒ</div>';

                Object.keys(VARIATION_TYPES_MAP).forEach(typeKey => {
                    const variantDetailArea = contentArea.querySelector(`#${tool}-${typeKey}-variant-details`);
                    if(variantDetailArea) variantDetailArea.innerHTML = '<div class="no-image-message">ë°ì´í„° ì—†ìŒ</div>';
                });
            });
        }


        function copyIndividualPrompt(aiTool, fieldKey) {
            if (!currentConceptId || !currentConceptType) { showToast('ì„ íƒëœ ì»¨ì…‰ì•„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
            const concept = conceptArtData[currentConceptType][currentConceptId];
            const textToCopy = concept?.prompts?.[aiTool]?.[fieldKey] || '';
            if (!textToCopy) { showToast(`${aiTool} ${fieldKey} ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.`); return; }
            copyToClipboard(textToCopy, `${aiTool} ${fieldKey} í”„ë¡¬í”„íŠ¸ê°€`);
        }

        function displayVariantPrompts(variationsByAI, conceptType) {
            const variantsMainContent = document.getElementById('variants-main-content');
            const variantsPlaceholder = document.getElementById('variants-placeholder');

            if (conceptType !== 'character') {
                variantsMainContent.style.display = 'none';
                variantsPlaceholder.style.display = 'block';
                return;
            }
            variantsMainContent.style.display = 'block';
            variantsPlaceholder.style.display = 'none';

            AI_TOOLS.forEach(tool => {
                const toolVariations = variationsByAI?.[tool];
                Object.keys(VARIATION_TYPES_MAP).forEach(typeKey => {
                    const container = document.getElementById(`${tool}-${typeKey}-variant-details`);
                    if (!container) return;
                    container.innerHTML = '';

                    const schemaKeyBase = VARIATION_TYPES_MAP[typeKey].schema_key_base;
                    let variationPrompts;

                    if (tool === 'midjourney') {
                        const englishPrompt = toolVariations?.[`${schemaKeyBase}_permutation_english`];
                        const translatedPrompt = toolVariations?.[`${schemaKeyBase}_permutation_translated`];
                        if (englishPrompt || translatedPrompt) {
                            variationPrompts = [{ english: englishPrompt, translated: translatedPrompt }]; // Treat as a single item array for consistent handling
                        }
                    } else {
                        variationPrompts = toolVariations?.[schemaKeyBase]; // This is an array of promptPair objects
                    }

                    if (!variationPrompts || variationPrompts.length === 0) {
                        container.innerHTML = `<div class="no-image-message">${VARIATION_TYPES_MAP[typeKey].name_kr} ë³€í˜• í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                        return;
                    }
                    
                    variationPrompts.forEach((promptData, index) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'variant-item';
                        itemDiv.innerHTML = `
                            <h4>${VARIATION_TYPES_MAP[typeKey].name_kr} #${tool === 'midjourney' ? 'ìˆœì—´' : index + 1}</h4>
                            <div class="variant-prompt-pair">
                                <span class="label">ì˜ì–´:</span>
                                <div class="prompt-box">${promptData.english || 'ë‚´ìš© ì—†ìŒ'}</div>
                                <button class="button btn-sm" onclick="copyToClipboard('${(promptData.english || '').replace(/'/g, "\\'")}', 'ì˜ì–´ í”„ë¡¬í”„íŠ¸ê°€')">ì˜ì–´ ë³µì‚¬</button>
                            </div>
                            <div class="variant-prompt-pair">
                                <span class="label">ë²ˆì—­:</span>
                                <div class="prompt-box">${promptData.translated || 'ë‚´ìš© ì—†ìŒ'}</div>
                                <button class="button btn-sm" onclick="copyToClipboard('${(promptData.translated || '').replace(/'/g, "\\'")}', 'ë²ˆì—­ í”„ë¡¬í”„íŠ¸ê°€')">ë²ˆì—­ ë³µì‚¬</button>
                            </div>
                            <div class="image-preview-container">
                                <h5>ìƒì„±ëœ ì´ë¯¸ì§€</h5>
                                <div class="image-display-area" id="${tool}-${typeKey}-${index}-variant-image-display">
                                    <div class="no-image-message">ì´ë¯¸ì§€ ì—†ìŒ</div>
                                </div>
                                <div style="display: flex; gap: 6px; margin-top: 6px;">
                                    <button class="button secondary btn-sm" onclick="addImageUrl('${tool}', '${typeKey}', ${index})">ğŸ”— URL</button>
                                    <button class="button secondary btn-sm" onclick="uploadImageFile('${tool}', '${typeKey}', ${index})">ğŸ“ ì—…ë¡œë“œ</button>
                                </div>
                            </div>`;
                        container.appendChild(itemDiv);
                        displayImage(tool, `${typeKey}_${index}`, conceptArtData[currentConceptType]?.[currentConceptId]?.generated_images?.variations?.[tool]?.[`${schemaKeyBase}_${index}`]);
                    });
                });
            });
            if (AI_TOOLS.length > 0) openAITab(null, currentVariantsAITab || AI_TOOLS[0], 'variant-prompt-ai-tabs', 'variant-prompt-ai-content-area');
        }
        
        function displayImage(aiTool, typeOrSubtype, imageUrl, index = null) {
            let imageDisplayAreaId;
            if (typeOrSubtype === 'base') { // Base prompt image
                imageDisplayAreaId = `${aiTool}-base-image-display`;
            } else { // Variant prompt image (typeOrSubtype is like 'face_views_4_0', 'expressions_5_1')
                 // index here is part of typeOrSubtype for variants already
                const [variationKey, itemIndex] = typeOrSubtype.split(/_(?=\d+$)/); // split on last underscore before number
                imageDisplayAreaId = `${aiTool}-${variationKey}-${itemIndex}-variant-image-display`;
            }

            const displayArea = document.getElementById(imageDisplayAreaId);
            if (!displayArea) {
                // console.warn(`Image display area not found: ${imageDisplayAreaId}`);
                return;
            }

            displayArea.innerHTML = ''; // Clear previous content
            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = `${aiTool} ${typeOrSubtype} ì´ë¯¸ì§€`;
                img.style.cursor = 'pointer';
                img.onclick = function() { openImageModal(imageUrl); };
                img.onerror = function() {
                    this.parentElement.innerHTML = '<div class="no-image-message">ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨. URLì„ í™•ì¸í•˜ì„¸ìš”.</div>';
                };
                img.style.cursor = 'pointer';
                img.onclick = function() { openImageModal(imageUrl); };
                displayArea.appendChild(img);
            } else {
                displayArea.innerHTML = '<div class="no-image-message">ì´ë¯¸ì§€ ì—†ìŒ</div>';
            }
        }

        function addImageUrl(aiTool, type, index = null) { // URL ì…ë ¥ ì „ìš© í•¨ìˆ˜
            if (!currentConceptId || !currentConceptType) { showToast('ì„ íƒëœ ì»¨ì…‰ì•„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

            const concept = conceptArtData[currentConceptType][currentConceptId];
            if (!concept.generated_images) concept.generated_images = { base_prompts: {}, variations: {} };
            if (type === 'base' && !concept.generated_images.base_prompts) concept.generated_images.base_prompts = {};
            if (type !== 'base' && !concept.generated_images.variations) concept.generated_images.variations = {};
            if (type !== 'base' && !concept.generated_images.variations[aiTool]) concept.generated_images.variations[aiTool] = {};

            const currentUrl = (type === 'base')
                ? (concept.generated_images.base_prompts?.[aiTool] || '')
                : (concept.generated_images.variations?.[aiTool]?.[`${VARIATION_TYPES_MAP[type].schema_key_base}_${index}`] || '');
            
            const newUrl = prompt(`[${aiTool.toUpperCase()}] ${type === 'base' ? 'ê¸°ë³¸' : VARIATION_TYPES_MAP[type].name_kr + ' #' + (index+1)} ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”:`, currentUrl);
            if (newUrl === null) return;
            
            setImageUrl(aiTool, type, index, newUrl.trim(), concept);
        }

        function uploadImageFile(aiTool, type, index = null) { // íŒŒì¼ ì—…ë¡œë“œ ì „ìš© í•¨ìˆ˜
            if (!currentConceptId || !currentConceptType) { showToast('ì„ íƒëœ ì»¨ì…‰ì•„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

            const concept = conceptArtData[currentConceptType][currentConceptId];
            if (!concept.generated_images) concept.generated_images = { base_prompts: {}, variations: {} };
            if (type === 'base' && !concept.generated_images.base_prompts) concept.generated_images.base_prompts = {};
            if (type !== 'base' && !concept.generated_images.variations) concept.generated_images.variations = {};
            if (type !== 'base' && !concept.generated_images.variations[aiTool]) concept.generated_images.variations[aiTool] = {};

            selectLocalImageFile(aiTool, type, index, concept);
        }

        function setImageUrl(aiTool, type, index, imageUrl, concept) {
            if (type === 'base') {
                concept.generated_images.base_prompts[aiTool] = imageUrl;
                displayImage(aiTool, 'base', imageUrl);
            } else {
                const variationKey = `${VARIATION_TYPES_MAP[type].schema_key_base}_${index}`;
                concept.generated_images.variations[aiTool][variationKey] = imageUrl;
                displayImage(aiTool, `${type}_${index}`, imageUrl);
            }
            saveDataToLocalStorage();
            updateImageGallery(concept);
            showToast('ì´ë¯¸ì§€ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function selectLocalImageFile(aiTool, type, index, concept) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.style.display = 'none';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // ì´ë¯¸ì§€ íŒŒì¼ì„ Data URLë¡œ ë³€í™˜
                const reader = new FileReader();
                reader.onload = function(event) {
                    const dataUrl = event.target.result;
                    setImageUrl(aiTool, type, index, dataUrl, concept);
                };
                reader.readAsDataURL(file);
                
                // input ìš”ì†Œ ì •ë¦¬
                document.body.removeChild(input);
            };
            
            input.oncancel = function() {
                document.body.removeChild(input);
            };
            
            document.body.appendChild(input);
            input.click();
        }

        function updateImageGallery(concept) {
            const galleryContent = document.getElementById('image-gallery-content');
            galleryContent.innerHTML = '';
            if (!concept || !concept.name) {
                 galleryContent.innerHTML = '<div class="no-image-message">ì»¨ì…‰ì•„íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
                return;
            }

            const imagesForGallery = [];
            // Base prompt images
            if (concept.generated_images?.base_prompts) {
                AI_TOOLS.forEach(tool => {
                    if (concept.generated_images.base_prompts[tool]) {
                        imagesForGallery.push({
                            name: `${concept.name} - ${tool.charAt(0).toUpperCase() + tool.slice(1)} ê¸°ë³¸`,
                            imageUrl: concept.generated_images.base_prompts[tool],
                            prompt: concept.prompts?.[tool]?.prompt_english || ''
                        });
                    }
                });
            }
            // Variant prompt images
            if (concept.type === 'character' && concept.generated_images?.variations) {
                AI_TOOLS.forEach(tool => {
                    if (concept.generated_images.variations[tool]) {
                        Object.keys(concept.generated_images.variations[tool]).forEach(variationKey => { // e.g., face_views_4_0
                            const imageUrl = concept.generated_images.variations[tool][variationKey];
                            if (imageUrl) {
                                const [typeBase, itemIndexStr] = variationKey.split(/_(?=\d+$)/); // face_views_4, 0
                                const itemIndex = parseInt(itemIndexStr);
                                let promptData;
                                if(tool === 'midjourney') {
                                    promptData = concept.variations?.[tool]?.[`${typeBase}_permutation_english`]; // single string
                                } else {
                                     promptData = concept.variations?.[tool]?.[typeBase]?.[itemIndex]?.english;
                                }
                                
                                let variationDisplayName = typeBase;
                                for(const htmlKey in VARIATION_TYPES_MAP) {
                                    if(VARIATION_TYPES_MAP[htmlKey].schema_key_base === typeBase) {
                                        variationDisplayName = VARIATION_TYPES_MAP[htmlKey].name_kr;
                                        break;
                                    }
                                }

                                imagesForGallery.push({
                                    name: `${concept.name} - ${tool.charAt(0).toUpperCase() + tool.slice(1)} ${variationDisplayName} #${tool === 'midjourney' ? 'ìˆœì—´' :itemIndex + 1}`,
                                    imageUrl: imageUrl,
                                    prompt: promptData || ''
                                });
                            }
                        });
                    }
                });
            }

            if (imagesForGallery.length === 0) {
                galleryContent.innerHTML = '<div class="no-image-message">ì´ ì»¨ì…‰ì•„íŠ¸ì— ì¶”ê°€ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            imagesForGallery.forEach(imgData => galleryContent.appendChild(createImageCard(imgData)));
        }

        function createImageCard(imageData) {
            const card = document.createElement('div');
            card.className = 'image-card';
            const img = document.createElement('img');
            img.src = imageData.imageUrl;
            img.alt = imageData.name;
			img.style.cursor = 'pointer';
            img.onclick = function() { openImageModal(imageData.imageUrl); };
            img.onerror = function() { /* basic error handling */ this.parentElement.innerHTML = `<div class="no-image-message" style="height:180px; display:flex; align-items:center; justify-content:center;">${imageData.name}<br/>(ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨)</div>`; };
            const info = document.createElement('div');
            info.className = 'image-card-info';
            const title = document.createElement('h4');
            title.textContent = imageData.name;
            const promptPreview = document.createElement('p');
            const pText = imageData.prompt || 'í”„ë¡¬í”„íŠ¸ ì •ë³´ ì—†ìŒ';
            promptPreview.textContent = pText.length > 40 ? pText.substring(0, 40) + '...' : pText;
            promptPreview.title = pText; // Full prompt on hover
            info.appendChild(title);
            info.appendChild(promptPreview);
            card.appendChild(img);
            card.appendChild(info);
            return card;
        }
        
        // --- Tab Control ---
        function openTab(event, tabId) {
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.querySelectorAll('.tabs > .tab-button').forEach(tb => tb.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if (event) event.currentTarget.classList.add('active');
            else document.querySelector(`.tabs > .tab-button[onclick*="'${tabId}'"]`).classList.add('active');
        }

        function openAITab(event, aiTool, tabsContainerId, contentAreaId) {
            currentPromptsAITab = (tabsContainerId === 'base-prompt-ai-tabs') ? aiTool : currentPromptsAITab;
            currentVariantsAITab = (tabsContainerId === 'variant-prompt-ai-tabs') ? aiTool : currentVariantsAITab;

            document.querySelectorAll(`#${tabsContainerId} .tab-button`).forEach(btn => btn.classList.remove('active'));
            if (event) event.currentTarget.classList.add('active');
            else document.querySelector(`#${tabsContainerId} .tab-button[onclick*="'${aiTool}'"]`)?.classList.add('active');


            document.querySelectorAll(`#${contentAreaId} > div`).forEach(content => content.classList.remove('active'));
            const activeContentId = (tabsContainerId === 'base-prompt-ai-tabs') ? `base-prompt-${aiTool}-content` : `variant-prompt-${aiTool}-content`;
            document.getElementById(activeContentId)?.classList.add('active');
            
            // If opening variant AI tab, ensure its current nested tab is also opened
            if (tabsContainerId === 'variant-prompt-ai-tabs' && currentConceptType === 'character') {
                 openNestedTab(null, aiTool, currentVariantTypeTab[aiTool] || 'face_views_4');
            }
        }

        function openNestedTab(event, aiTool, variantTypeKey) { // variantTypeKey is 'face_views_4', 'expressions_5', etc.
            currentVariantTypeTab[aiTool] = variantTypeKey;
            document.querySelectorAll(`#variant-prompt-${aiTool}-content .nested-tabs .nested-tab-button`).forEach(btn => btn.classList.remove('active'));
             if (event) event.currentTarget.classList.add('active');
             else document.querySelector(`#variant-prompt-${aiTool}-content .nested-tabs .nested-tab-button[onclick*="'${variantTypeKey}'"]`)?.classList.add('active');


            document.querySelectorAll(`#variant-prompt-${aiTool}-content .nested-tab-content`).forEach(content => content.classList.remove('active'));
            document.getElementById(`${aiTool}-${variantTypeKey}-variant-details`)?.classList.add('active');
        }
        
        // --- Clipboard Utility ---
        function copyToClipboard(text, type = "í…ìŠ¤íŠ¸ê°€") {
            if (!text) {
                showToast(`${type} ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast(`${type} í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                }).catch(err => {
                    console.warn('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨ (navigator.clipboard):', err);
                    fallbackCopyToClipboard(text, type); 
                });
            } else {
                fallbackCopyToClipboard(text, type);
            }
        }
        // ì´ë¯¸ì§€ ëª¨ë‹¬ í•¨ìˆ˜ë“¤
			function openImageModal(imageUrl) {
				const modal = document.getElementById('imageModal');
				const modalImg = document.getElementById('modalImage');
				if (modal && modalImg && imageUrl) {
					modal.style.display = 'flex';
					modalImg.src = imageUrl;
				}
			}

			function closeImageModal(event) {
				const modal = document.getElementById('imageModal');
				if (modal && (event.target === modal || event.target.classList.contains('image-modal-close'))) {
					modal.style.display = 'none';
					document.getElementById('modalImage').src = '';
				}
			}

        function fallbackCopyToClipboard(text, type) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; 
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                if (document.execCommand('copy')) {
                    showToast(`${type} í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                } else {
                    showToast('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (err) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨ (execCommand):', err);
                showToast('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            document.body.removeChild(textarea);
        }

    </script>
</body>
</html>