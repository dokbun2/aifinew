<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase RLS í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .sql-fix {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            overflow-x: auto;
        }

        .sql-fix pre {
            margin: 0;
            white-space: pre-wrap;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .test-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #e0e0e0;
        }

        .test-card.success {
            border-color: #4CAF50;
        }

        .test-card.error {
            border-color: #f44336;
        }

        .test-card h3 {
            margin-top: 0;
            color: #333;
        }

        #results {
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Supabase RLS ì •ì±… í…ŒìŠ¤íŠ¸</h1>

    <div class="test-section">
        <h2>1. ì—°ê²° í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testConnection()">ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
        <button onclick="clearResults()">ê²°ê³¼ ì´ˆê¸°í™”</button>
        <div id="connectionResults"></div>
    </div>

    <div class="test-section">
        <h2>2. RLS ê¶Œí•œ í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testRLSPermissions()">RLS ê¶Œí•œ í…ŒìŠ¤íŠ¸</button>
        <div id="rlsResults"></div>
    </div>

    <div class="test-section">
        <h2>3. ì‹¤ì œ ë°ì´í„° ì €ì¥ í…ŒìŠ¤íŠ¸</h2>
        <input type="email" id="testEmail" placeholder="test@example.com" style="padding: 8px; margin-right: 10px;">
        <button onclick="testActualSave()">ì €ì¥ í…ŒìŠ¤íŠ¸</button>
        <div id="saveResults"></div>
    </div>

    <div class="test-section">
        <h2>4. RLS ì •ì±… ìˆ˜ì • SQL</h2>
        <div class="sql-fix">
            <pre id="sqlFix">-- Supabase SQL Editorì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”:

-- Option 1: RLS ì™„ì „ ë¹„í™œì„±í™” (í…ŒìŠ¤íŠ¸ìš©)
ALTER TABLE users DISABLE ROW LEVEL SECURITY;

-- Option 2: ê´€ëŒ€í•œ RLS ì •ì±… ì„¤ì • (ê¶Œì¥)
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- ê¸°ì¡´ ì •ì±… ì œê±°
DROP POLICY IF EXISTS "Enable read access for all users" ON users;
DROP POLICY IF EXISTS "Enable insert for all users" ON users;
DROP POLICY IF EXISTS "Enable update for all users" ON users;

-- ìƒˆ ì •ì±… ìƒì„±
CREATE POLICY "Allow all reads" ON users
FOR SELECT USING (true);

CREATE POLICY "Allow all inserts" ON users
FOR INSERT WITH CHECK (true);

CREATE POLICY "Allow all updates" ON users
FOR UPDATE USING (true) WITH CHECK (true);

-- ê¶Œí•œ ë¶€ì—¬
GRANT ALL ON users TO anon;
GRANT ALL ON users TO authenticated;
GRANT USAGE ON SCHEMA public TO anon;
GRANT USAGE ON SCHEMA public TO authenticated;</pre>
        </div>
        <button onclick="copySQLToClipboard()">SQL ë³µì‚¬</button>
    </div>

    <div class="test-section">
        <h2>5. í…ŒìŠ¤íŠ¸ ê²°ê³¼</h2>
        <div id="results"></div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script type="module">
        // Supabase ì„¤ì • ë¡œë“œ
        import { SUPABASE_CONFIG } from './js/modules/supabase-config.js';
        window.SUPABASE_CONFIG = SUPABASE_CONFIG;
    </script>

    <script>
        let supabaseClient = null;

        // ì´ˆê¸°í™”
        async function initSupabase() {
            if (!window.SUPABASE_CONFIG) {
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            if (window.supabase && window.SUPABASE_CONFIG) {
                supabaseClient = window.supabase.createClient(
                    window.SUPABASE_CONFIG.url,
                    window.SUPABASE_CONFIG.anonKey
                );
                addResult('Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ', 'success');
                return true;
            }
            addResult('Supabase ì´ˆê¸°í™” ì‹¤íŒ¨', 'error');
            return false;
        }

        // ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testConnection() {
            clearResults();
            addResult('ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...', 'info');

            if (!supabaseClient) {
                await initSupabase();
            }

            if (!supabaseClient) {
                addResult('Supabase í´ë¼ì´ì–¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            // 1. Health Check
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('count')
                    .limit(1);

                if (error) {
                    addResult(`âŒ Health Check ì‹¤íŒ¨: ${error.message}`, 'error');
                    addResult(`Error Code: ${error.code}`, 'error');
                    if (error.hint) addResult(`Hint: ${error.hint}`, 'warning');
                } else {
                    addResult('âœ… Health Check ì„±ê³µ', 'success');
                }
            } catch (e) {
                addResult(`âŒ ì—°ê²° ì˜ˆì™¸: ${e.message}`, 'error');
            }

            // 2. URL í™•ì¸
            addResult(`Supabase URL: ${window.SUPABASE_CONFIG.url}`, 'info');
        }

        // RLS ê¶Œí•œ í…ŒìŠ¤íŠ¸
        async function testRLSPermissions() {
            const rlsResults = document.getElementById('rlsResults');
            rlsResults.innerHTML = '<div class="loading"></div> í…ŒìŠ¤íŠ¸ ì¤‘...';

            if (!supabaseClient) {
                await initSupabase();
            }

            const results = [];

            // SELECT í…ŒìŠ¤íŠ¸
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .limit(1);

                if (error) {
                    results.push({
                        operation: 'SELECT',
                        status: 'error',
                        message: error.message,
                        code: error.code
                    });
                } else {
                    results.push({
                        operation: 'SELECT',
                        status: 'success',
                        message: 'ì½ê¸° ê¶Œí•œ ìˆìŒ'
                    });
                }
            } catch (e) {
                results.push({
                    operation: 'SELECT',
                    status: 'error',
                    message: e.message
                });
            }

            // INSERT í…ŒìŠ¤íŠ¸
            try {
                const testEmail = `test_${Date.now()}@test.com`;
                const { data, error } = await supabaseClient
                    .from('users')
                    .insert({
                        email: testEmail,
                        name: 'RLS Test User',
                        status: 'test',
                        created_at: new Date().toISOString()
                    })
                    .select();

                if (error) {
                    results.push({
                        operation: 'INSERT',
                        status: 'error',
                        message: error.message,
                        code: error.code
                    });

                    if (error.code === '42501') {
                        results.push({
                            operation: 'RLS',
                            status: 'error',
                            message: 'RLS ì •ì±…ì´ INSERTë¥¼ ì°¨ë‹¨í•˜ê³  ìˆìŠµë‹ˆë‹¤!'
                        });
                    }
                } else {
                    results.push({
                        operation: 'INSERT',
                        status: 'success',
                        message: 'ì“°ê¸° ê¶Œí•œ ìˆìŒ'
                    });

                    // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ
                    await supabaseClient
                        .from('users')
                        .delete()
                        .eq('email', testEmail);
                }
            } catch (e) {
                results.push({
                    operation: 'INSERT',
                    status: 'error',
                    message: e.message
                });
            }

            // ê²°ê³¼ í‘œì‹œ
            rlsResults.innerHTML = '';
            results.forEach(result => {
                const div = document.createElement('div');
                div.className = `test-result ${result.status}`;
                div.innerHTML = `
                    <strong>${result.operation}:</strong> ${result.message}
                    ${result.code ? `<br>Code: ${result.code}` : ''}
                `;
                rlsResults.appendChild(div);
            });
        }

        // ì‹¤ì œ ì €ì¥ í…ŒìŠ¤íŠ¸
        async function testActualSave() {
            const email = document.getElementById('testEmail').value || `test_${Date.now()}@test.com`;
            const saveResults = document.getElementById('saveResults');

            saveResults.innerHTML = '<div class="loading"></div> ì €ì¥ ì¤‘...';

            if (!supabaseClient) {
                await initSupabase();
            }

            try {
                const userData = {
                    email: email,
                    name: 'Test User',
                    picture: '',
                    google_id: `test_${Date.now()}`,
                    status: 'pending',
                    created_at: new Date().toISOString(),
                    last_login: new Date().toISOString(),
                    login_count: 1,
                    metadata: {
                        test: true,
                        timestamp: new Date().toISOString()
                    }
                };

                const { data, error } = await supabaseClient
                    .from('users')
                    .upsert(userData, {
                        onConflict: 'email',
                        ignoreDuplicates: false
                    })
                    .select();

                saveResults.innerHTML = '';

                if (error) {
                    saveResults.innerHTML = `
                        <div class="test-result error">
                            âŒ ì €ì¥ ì‹¤íŒ¨<br>
                            Message: ${error.message}<br>
                            Code: ${error.code}<br>
                            ${error.hint ? `Hint: ${error.hint}` : ''}
                        </div>
                    `;

                    if (error.code === '42501' || error.message.includes('row-level security')) {
                        saveResults.innerHTML += `
                            <div class="test-result warning">
                                âš ï¸ RLS ì •ì±… ë¬¸ì œì…ë‹ˆë‹¤!<br>
                                ìœ„ì˜ SQLì„ Supabase SQL Editorì—ì„œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.
                            </div>
                        `;
                    }
                } else {
                    saveResults.innerHTML = `
                        <div class="test-result success">
                            âœ… ì €ì¥ ì„±ê³µ!<br>
                            Email: ${data[0].email}<br>
                            ID: ${data[0].id}<br>
                            Status: ${data[0].status}
                        </div>
                    `;
                }
            } catch (e) {
                saveResults.innerHTML = `
                    <div class="test-result error">
                        âŒ ì˜ˆì™¸ ë°œìƒ: ${e.message}
                    </div>
                `;
            }
        }

        // ê²°ê³¼ ì¶”ê°€
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        // ê²°ê³¼ ì´ˆê¸°í™”
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('connectionResults').innerHTML = '';
        }

        // SQL ë³µì‚¬
        function copySQLToClipboard() {
            const sqlText = document.getElementById('sqlFix').textContent;
            navigator.clipboard.writeText(sqlText).then(() => {
                alert('SQLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', async () => {
            await initSupabase();
        });
    </script>
</body>
</html>